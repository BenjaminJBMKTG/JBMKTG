<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>LinkDrop</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”—</text></svg>">
<style>
  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface2: #334155;
    --text: #f8fafc;
    --muted: #94a3b8;
    --blue: #3b82f6;
    --blue-hover: #2563eb;
    --green: #22c55e;
    --red: #ef4444;
    --border: #334155;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
  }
  .container { max-width: 640px; margin: 0 auto; padding: 20px 16px; }

  /* Header */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 0 24px;
  }
  .header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; }
  .header h1 span { color: var(--blue); }
  .badge {
    background: var(--blue); color: white; font-size: 13px; font-weight: 700;
    padding: 4px 10px; border-radius: 99px; min-width: 28px; text-align: center;
  }
  .badge.zero { background: var(--surface2); color: var(--muted); }

  /* Add form */
  .add-form {
    display: flex; gap: 10px; margin-bottom: 24px;
  }
  .add-form input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); border-radius: 12px; padding: 14px 16px; font-size: 16px;
    outline: none; transition: border-color 0.2s;
  }
  .add-form input:focus { border-color: var(--blue); }
  .add-form input::placeholder { color: var(--muted); }
  .add-form button {
    background: var(--blue); color: white; border: none; border-radius: 12px;
    padding: 14px 20px; font-size: 16px; font-weight: 600; cursor: pointer;
    transition: background 0.2s; white-space: nowrap;
  }
  .add-form button:hover { background: var(--blue-hover); }
  .add-form button:active { transform: scale(0.97); }

  /* Tabs */
  .tabs {
    display: flex; gap: 4px; margin-bottom: 20px;
    background: var(--surface); border-radius: 12px; padding: 4px;
  }
  .tab {
    flex: 1; padding: 10px; text-align: center; border-radius: 10px;
    font-size: 14px; font-weight: 600; cursor: pointer; color: var(--muted);
    transition: all 0.2s; border: none; background: none;
  }
  .tab.active { background: var(--blue); color: white; }

  /* Link card */
  .link-card {
    background: var(--surface); border-radius: 14px; padding: 16px;
    margin-bottom: 10px; transition: all 0.2s;
    border: 1px solid transparent;
    animation: slideIn 0.25s ease-out;
  }
  .link-card:hover { border-color: var(--border); }
  .link-card.reviewed { opacity: 0.5; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } }

  .link-top { display: flex; align-items: flex-start; gap: 12px; }
  .link-favicon {
    width: 36px; height: 36px; border-radius: 10px; background: var(--surface2);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-size: 18px; overflow: hidden;
  }
  .link-favicon img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
  .link-info { flex: 1; min-width: 0; }
  .link-title {
    font-size: 15px; font-weight: 600; margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .link-url {
    font-size: 13px; color: var(--muted);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .link-url a { color: var(--muted); text-decoration: none; }
  .link-url a:hover { color: var(--blue); }

  .link-actions {
    display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end;
  }
  .link-btn {
    background: var(--surface2); border: none; color: var(--muted);
    border-radius: 8px; padding: 8px 14px; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px;
  }
  .link-btn:hover { color: var(--text); background: var(--border); }
  .link-btn.review { color: var(--green); }
  .link-btn.delete { color: var(--red); }
  .link-btn.open { color: var(--blue); }

  .link-time { font-size: 12px; color: var(--muted); margin-top: 10px; }
  .link-new {
    display: inline-block; background: var(--blue); color: white;
    font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px;
    margin-left: 8px; vertical-align: middle;
  }

  /* Empty state */
  .empty {
    text-align: center; padding: 60px 20px; color: var(--muted);
  }
  .empty .emoji { font-size: 48px; margin-bottom: 16px; }
  .empty p { font-size: 15px; line-height: 1.6; }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: var(--green); color: white; padding: 12px 24px;
    border-radius: 12px; font-size: 14px; font-weight: 600;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
  }
  .toast.show { opacity: 1; }

  /* Responsive */
  @media (max-width: 480px) {
    .container { padding: 12px; }
    .add-form { flex-direction: column; }
    .add-form button { padding: 14px; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ðŸ”— Link<span>Drop</span></h1>
    <div class="badge zero" id="unreadBadge">0</div>
  </div>

  <form class="add-form" id="addForm">
    <input type="url" id="urlInput" placeholder="Paste a link..." autocomplete="off" required>
    <button type="submit">+ Save</button>
  </form>

  <div class="tabs">
    <button class="tab active" data-tab="new" id="tabNew">New</button>
    <button class="tab" data-tab="reviewed" id="tabReviewed">Reviewed</button>
  </div>

  <div id="linkList"></div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = 'https://hixpsdxekxmpsvkbrzsz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_-o3nV01KOqFBlYlAC3f1tA_ll2HVKWH';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let links = [];
let currentTab = 'new';

// Elements
const addForm = document.getElementById('addForm');
const urlInput = document.getElementById('urlInput');
const linkList = document.getElementById('linkList');
const unreadBadge = document.getElementById('unreadBadge');

// Check for shared URL in query params (from share target)
const params = new URLSearchParams(window.location.search);
const sharedUrl = params.get('url') || params.get('text');
if (sharedUrl) {
  // Extract URL from text if needed
  const urlMatch = sharedUrl.match(/https?:\/\/[^\s]+/);
  if (urlMatch) {
    saveLink(urlMatch[0]).then(() => {
      window.history.replaceState({}, '', window.location.pathname);
    });
  }
}

// Load links
async function loadLinks() {
  const { data, error } = await sb
    .from('links')
    .select('*')
    .order('created_at', { ascending: false });
  if (!error) {
    links = data || [];
    render();
  }
}

// Save a link
async function saveLink(url) {
  // Try to fetch title
  let title = null;
  try {
    const hostname = new URL(url).hostname.replace('www.', '');
    title = hostname; // fallback
  } catch(e) {}

  const { data, error } = await sb
    .from('links')
    .insert({ url, title })
    .select()
    .single();

  if (!error && data) {
    links.unshift(data);
    render();
    showToast('Link saved! ðŸŽ‰');
    // Try to fetch real title in background
    fetchTitle(data.id, url);
  }
  return data;
}

// Fetch page title via a simple proxy approach
async function fetchTitle(id, url) {
  try {
    // Use allorigins as a CORS proxy to get the page title
    const resp = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    const html = await resp.text();
    const match = html.match(/<title[^>]*>([^<]+)<\/title>/i);
    if (match && match[1]) {
      const title = match[1].trim().substring(0, 200);
      await sb.from('links').update({ title }).eq('id', id);
      const link = links.find(l => l.id === id);
      if (link) { link.title = title; render(); }
    }
  } catch(e) { /* silently fail */ }
}

// Toggle reviewed
async function toggleReview(id) {
  const link = links.find(l => l.id === id);
  if (!link) return;
  const reviewed = !link.reviewed;
  await sb.from('links').update({
    reviewed,
    reviewed_at: reviewed ? new Date().toISOString() : null
  }).eq('id', id);
  link.reviewed = reviewed;
  link.reviewed_at = reviewed ? new Date().toISOString() : null;
  render();
}

// Delete link
async function deleteLink(id) {
  await sb.from('links').delete().eq('id', id);
  links = links.filter(l => l.id !== id);
  render();
}

// Copy URL
function copyUrl(url) {
  navigator.clipboard.writeText(url);
  showToast('Copied! ðŸ“‹');
}

// Render
function render() {
  const filtered = links.filter(l => currentTab === 'new' ? !l.reviewed : l.reviewed);
  const unread = links.filter(l => !l.reviewed).length;

  unreadBadge.textContent = unread;
  unreadBadge.className = unread > 0 ? 'badge' : 'badge zero';

  if (filtered.length === 0) {
    linkList.innerHTML = `
      <div class="empty">
        <div class="emoji">${currentTab === 'new' ? 'ðŸ“­' : 'âœ…'}</div>
        <p>${currentTab === 'new'
          ? 'No links yet.<br>Paste one above or share from your phone!'
          : 'No reviewed links yet.'}</p>
      </div>`;
    return;
  }

  linkList.innerHTML = filtered.map(link => {
    const time = timeAgo(new Date(link.created_at));
    const hostname = (() => { try { return new URL(link.url).hostname.replace('www.',''); } catch(e) { return ''; } })();
    const favicon = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
    const isNew = !link.reviewed && (Date.now() - new Date(link.created_at).getTime()) < 3600000;

    return `
      <div class="link-card ${link.reviewed ? 'reviewed' : ''}">
        <div class="link-top">
          <div class="link-favicon"><img src="${favicon}" onerror="this.parentElement.innerHTML='ðŸ”—'"></div>
          <div class="link-info">
            <div class="link-title">${escHtml(link.title || hostname)}${isNew ? '<span class="link-new">NEW</span>' : ''}</div>
            <div class="link-url"><a href="${escHtml(link.url)}" target="_blank" rel="noopener">${escHtml(hostname + new URL(link.url).pathname)}</a></div>
          </div>
        </div>
        <div class="link-time">${time}</div>
        <div class="link-actions">
          <button class="link-btn open" onclick="window.open('${escHtml(link.url)}','_blank')">Open â†—</button>
          <button class="link-btn" onclick="copyUrl('${escHtml(link.url)}')">Copy</button>
          <button class="link-btn review" onclick="toggleReview('${link.id}')">${link.reviewed ? 'â†© Unmark' : 'âœ“ Done'}</button>
          <button class="link-btn delete" onclick="if(confirm('Delete?'))deleteLink('${link.id}')">âœ•</button>
        </div>
      </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function timeAgo(date) {
  const s = Math.floor((Date.now() - date.getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  if (s < 604800) return Math.floor(s/86400) + 'd ago';
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentTab = tab.dataset.tab;
    render();
  });
});

// Form submit
addForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const url = urlInput.value.trim();
  if (!url) return;
  urlInput.value = '';
  await saveLink(url);
});

// Real-time subscription
sb.channel('links-changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'links' }, (payload) => {
    if (payload.eventType === 'INSERT') {
      // Only add if we don't already have it (avoid duplicates from our own inserts)
      if (!links.find(l => l.id === payload.new.id)) {
        links.unshift(payload.new);
        render();
        showToast('New link from another device! ðŸ“±');
      }
    } else if (payload.eventType === 'UPDATE') {
      const idx = links.findIndex(l => l.id === payload.new.id);
      if (idx >= 0) { links[idx] = payload.new; render(); }
    } else if (payload.eventType === 'DELETE') {
      links = links.filter(l => l.id !== payload.old.id);
      render();
    }
  })
  .subscribe();

// Init
loadLinks();

// Register service worker for PWA + share target
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
